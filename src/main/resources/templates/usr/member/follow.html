<html layout:decorate="~{layout}" xmlns:layout="http://www.w3.org/1999/xhtml">

<head>
    <title>
        친구 목록
    </title>

</head>

<body>

<div layout:fragment="content">
    <div class="hero-content flex flex-col my-10">
        <h2 class="text-4xl mt-5 my-5 font-bold flex flex-col">
            친구 목록
        </h2>

        <div class="flex gap-4 items-center border-2 border-blue-200 p-3 rounded mb-5">
            나의 닉네임
            <span class="text-2xl font-bold" th:text="${@rq.member.nickname}"></span>
        </div>
        <div class="w-full flex justify-center">
            <form th:action="@{'/follow/' + ${nickname}}" method="post"
                  onsubmit="FollowForm__submit(this); return false" class="mb-4">
                <label class="label">
                    <span class="label-text">사용자 검색</span>
                </label>
                <div class="flex gap-2">
                    <div class="form-control ">
                        <input type="text" placeholder="팔로우 할 닉네임을 검색하세요"
                               class="input input-bordered w-full max-w-lg"
                               name="nickname"/>
                    </div>
                    <div sec:authorize="isAuthenticated()">
                        <button type="submit" class="btn">등록</button>
                    </div>
                </div>

            </form>
        </div>

        <div class="flex justify-center w-full max-w-sm">
            <div>
                <table class="table w-full">
                    <tr class="text-center font-bold text-lg">
                        <th>팔로잉 <span id="followingCount" th:text="${#lists.size(followingList)}"></span></th>
                    </tr>
                    <div id="followingTableBody">
                        <tr class="hover" th:each="following, loop : ${followingList}">
                            <td>
                                <a th:href="@{'follow/friend/' + ${following.id}}">
                                    <span th:text="${following.nickname}"></span>
                                </a>
                            </td>
                        </tr>
                    </div>
                </table>
            </div>
            <div class="divider divider-horizontal"></div>
            <div>
                <table class="table w-full">
                    <tr class="text-center font-bold text-lg">
                        <th>팔로워 <span th:text="${#lists.size(followerList)}"></span></th>
                    </tr>
                    <tr class="hover" th:each="follwer, loop : ${followerList}">
                        <td><span th:text="${follwer.nickname}"></span></td>
                    </tr>
                </table>
            </div>

        </div>
    </div>

    <script>
        // csrf 토큰
        var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        function FollowForm__submit(form) {
            var nicknameInput = form.querySelector('input[name="nickname"]');
            var nickname = nicknameInput.value.trim();

            if (nickname.trim() === '') {
                toastWarning('팔로우 할 사용자의 닉네임을 입력하세요.');
                return;
            }

            var url = '/follow/' + nickname;
            var xhr = new XMLHttpRequest();

            xhr.open('POST', url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.setRequestHeader(csrfHeader, csrfToken);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    const response = JSON.parse(xhr.responseText);
                    const returnMessage = response.message;

                    if (xhr.status === 200) {
                        toastNotice(returnMessage);
                    } else {
                        toastWarning(returnMessage);
                    }
                }
            };

            var data = JSON.stringify({nickname: nickname});
            xhr.send(data);
        }
    </script>

</div>

</body>
</html>
