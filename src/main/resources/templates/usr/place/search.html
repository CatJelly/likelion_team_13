<html layout:decorate="~{layout}" xmlns:layout="http://www.w3.org/1999/xhtml">

<head>
    <title>장소 목록</title>
    <style>
        .customoverlay {
            position: relative;
            bottom: 50px;
            border-radius: 6px;
            border: 1px solid #ccc;
            border-bottom: 2px solid #ddd;
            float: left;
        }

        .customoverlay:nth-of-type(n) {
            border: 0;
            box-shadow: 0px 1px 2px #888;
        }

        .customoverlay a {
            display: block;
            text-decoration: none;
            color: #000;
            text-align: center;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            overflow: hidden;
            background: #d95050;
            background: #d95050 url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/arrow_white.png) no-repeat right 14px center;
        }

        .customoverlay .title {
            display: block;
            text-align: center;
            background: #fff;
            margin-right: 35px;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .customoverlay:after {
            content: '';
            position: absolute;
            margin-left: -12px;
            left: 50%;
            bottom: -12px;
            width: 22px;
            height: 12px;
            background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png')
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <script>
        getCurrentCoords(); // 현재 위치를 불러와 전역 변수에 저장 lat, lon
    </script>
    <div class="hero-content flex-col mb-10">
        <div class=" w-full px-4" style="width:1000px;">
            <div class="flex flex-col items-center my-5">
                <h1 class="text-4xl my-2 font-bold">장소 목록</h1>
            </div>

            <div class="bg-gray-30">
                <div>
                    <form th:action method="get"
                          id="searchForm"
                          onsubmit=submitCheck(this); return false;>
                        <input type="hidden" name="latitude" id="latitude" th:value="${latitude}">
                        <input type="hidden" name="longitude" id="longitude" th:value="${longitude}">
                        <input type="hidden" id="page" name="page" th:value="${paging.number}">

                        <div class="flex gap-4">
                                <div id="searchMap" class="border border-gray-400" style="width:100%;height:400px;"></div>
                            <div class="flex flex-col gap-4">
                                <select id="positionSelect" class="select-md form-select select select-warning">
                                    <option disabled selected>기준 위치</option>
                                    <option id="position1" value="current">현재 위치</option>
                                    <option id="position2" value="search">검색 위치</option>
                                </select>
                                <div class="flex flex-col gap-2">
                                    <div class="w-64 mx-auto  m-2">
                                        <select name="bigCategoryId"
                                                id="bigSelect"
                                                class="select-md form-select"
                                                onchange="showRelatedMidOptions(this)">
                                            <option disabled selected>대분류</option>
                                            <option th:each="bigCategory, loop : ${bigCategories}"
                                                    th:value="${bigCategory.id}"
                                                    th:selected="${selectedBig} == ${bigCategory.id}"
                                                    th:text="${bigCategory.categoryName}"></option>
                                        </select>
                                        <div class="form-select-arrow"></div>
                                    </div>
                                    <div class="w-64 mx-auto  m-2">
                                        <select name="midCategoryId"
                                                id="midSelect"
                                                class="select-md form-select"
                                                onchange="showRelatedSmallOptions(this)">
                                            <option disabled
                                                    selected
                                                    value="default">중분류
                                            </option>
                                            <option th:each="midCategory, loop : ${midCategories}"
                                                    th:class="${midCategory.bigCategoryId} + ' hidden'"
                                                    th:value="${midCategory.id}"
                                                    th:selected="${selectedMid} == ${midCategory.id}"
                                                    th:text="${midCategory.categoryName}"></option>
                                        </select>
                                        <div class="form-select-arrow"></div>
                                    </div>
                                    <div class="w-64 mx-auto  m-2">
                                        <select name="smallCategoryId" id="smallSelect" class="select-md form-select">
                                            <option disabled
                                                    selected
                                                    value="default">소분류
                                            </option>
                                            <option th:each="smallCategory, loop : ${smallCategories}"
                                                    th:class="${smallCategory.midCategoryId} + ' hidden'"
                                                    th:value="${smallCategory.id}"
                                                    th:selected="${selectedSmall} == ${smallCategory.id}"
                                                    th:text="${smallCategory.categoryName}"></option>
                                        </select>
                                        <div class="form-select-arrow"></div>
                                    </div>
                                    <button type="submit" id="searchButton" class="btn btn-warning mt-5">검색</button>
                                </div>

                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="container py-8">
                <div class="grid grid-cols-3 gap-5">
                    <div th:each="placeInfo, loop : ${placeInfoList}">
                        <a th:href="@{|/place/details/${placeInfo.place.id}|}"
                           class="card flex-shrink-0 w-full shadow-2xl bg-base-100">
                            <!--                           onclick="window.open(this.href, '_blank', 'width=600, height=700'); return false;">-->
                            <div class="card-body">
                                <div th:text="${placeInfo.place.placeName}" class="text-lg font-bold"></div>
                                <div class="flex justify-between">
                                    <div class="flex flex-col gap-2">
                                        <div th:if="${!#strings.isEmpty(placeInfo.bigCategoryName)}">
                                            <div class="badge badge-ghost badge-md"
                                                 th:text="${placeInfo.bigCategoryName}"></div>
                                        </div>
                                        <div th:if="${!#strings.isEmpty(placeInfo.midCategoryName)}">
                                            <div class="badge badge-ghost badge-md"
                                                 th:text="${placeInfo.midCategoryName}"></div>
                                        </div>
                                        <div th:if="${!#strings.isEmpty(placeInfo.smallCategoryName)}">
                                            <div class="badge badge-ghost badge-md"
                                                 th:text="${placeInfo.smallCategoryName}"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div>
                                            <i  class="fa-regular fa-heart text-red-400"></i>
                                            <span th:text="${placeInfo.place.likeCount != null ? placeInfo.place.likeCount : 0}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            <div th:if="${!paging.isEmpty()}" class="flex justify-center">
                <ul class="pagination justify-content-center flex">
                    <li class="page-item" th:classappend="${!paging.hasPrevious()} ? 'disabled'">
                        <a class="page-link m-1 btn  " href="javascript:void(0);"
                           th:data-page="${paging.number - 1}">
                            <span>이전</span>
                        </a>
                    </li>
                    <li th:each="page : ${#numbers.sequence(0, paging.totalPages - 1)}"
                        th:if="${page >= paging.number - 5 and page <= paging.number + 5}"
                        th:classappend="${page == paging.number} ? 'active'"
                        class="page-item">
                        <a th:text="${page}" class="page-link m-1 btn btn-outline" href="javascript:void(0);"
                           th:data-page="${page}"></a>
                    </li>
                    <li class="page-item" th:classappend="${!paging.hasNext()} ? 'disabled'">
                        <a class="page-link m-1 btn " href="javascript:void(0);"
                           th:data-page="${paging.number + 1}">
                            <span>다음</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2652c9851bbcfcd7c014b2339462c149&libraries=services"></script>
    <script th:inline="javascript">

        let placeArray = new Array();
        let placeInfo;
        /*[# th:each="place : ${visitedPlaces}"]*/
        placeInfo = {
            id: /*[[${place.id}]]*/null,
            name: /*[[${place.placeName}]]*/null,
            xPos: /*[[${place.point.x}]]*/null,
            yPos: /*[[${place.point.y}]]*/null
        };
        placeArray.push(placeInfo);
        /*[/]*/

        var xPosAverage = /*[[${xPosAverage}]]*/null;
        var yPosAverage = /*[[${yPosAverage}]]*/null;

        console.log(placeArray);

    </script>
    <script>
        var latitudeElement = document.getElementById('latitude');
        var longitudeElement = document.getElementById('longitude');
        var mapContainer = document.getElementById('searchMap'); // 카카오맵을 표시할 HTML 요소
        var mapOptions = {
            center: new kakao.maps.LatLng(37.510213, 127.036743),
            level: 3
        };
        var map = new kakao.maps.Map(mapContainer, mapOptions);

        // 현재 위치를 불러와 전역 변수에 저장 lat, lon

        document.getElementById("positionSelect").onchange = function () {
            var selectedOption = this.value;
            if(selectedOption === "current") {
                getCurrentCoords();
                var markerposition = new kakao.maps.LatLng(lat, lon)
                displayMarker(markerposition);
                function displayMarker(markerposition) {
                    var marker = new kakao.maps.Marker({
                        map: map,
                        position: markerposition
                    });
                    map.setCenter(markerposition);
                }

            } else if (selectedOption === "search") {
                // 검색 위치 선택 시, 카카오맵 마커 표시 및 장소 검색
                var latitude = parseFloat(document.getElementById("latitude").value);
                var longitude = parseFloat(document.getElementById("longitude").value);

                console.log("lal = " + latitude);
                console.log("long = " + longitude);
                // 카카오맵 초기화

                // 마커 추가
                var markerPosition = new kakao.maps.LatLng(latitude, longitude);
                var marker = new kakao.maps.Marker({
                    position: markerPosition
                });
                marker.setMap(map);

                kakao.maps.event.addListener(map, 'click', function(mouseEvent) {

                    var latlng = mouseEvent.latLng;

                    // 마커 위치를 클릭한 위치로 옮깁니다
                    marker.setPosition(latlng);
                });
                map.setCenter(markerPosition);


            }
        };
        // 탭 이동 관련
        const searchPlaceBtn = document.getElementById("searchButton");

        searchPlaceBtn.addEventListener("click", () => {

            // 마커를 표시할 위치와 title 객체 배열입니다
            var positions = [];

            for (var i = 0; i < placeArray.length; i++) {
                var place = placeArray[i];
                var position = {
                    id: place.id,
                    title: place.name,
                    latlng: new kakao.maps.LatLng(place.yPos, place.xPos)
                };
                positions.push(position);
            }

            // 마커 이미지의 이미지 주소입니다
            var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";

            for (var i = 0; i < positions.length; i++) {

                // 마커 이미지의 이미지 크기 입니다
                var imageSize = new kakao.maps.Size(24, 35);

                // 마커 이미지를 생성합니다
                var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                // 마커를 생성합니다
                var marker = new kakao.maps.Marker({
                    map: map, // 마커를 표시할 지도
                    position: positions[i].latlng, // 마커를 표시할 위치
                    title: positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
                    image: markerImage // 마커 이미지
                });

                var content = '<div class="customoverlay">' +
                    '  <a href="/place/details/' + positions[i].id + '" target="_blank">' +
                    '    <span class="title">' + positions[i].title + '</span>' +
                    '  </a>' +
                    '</div>';

                // 커스텀 오버레이를 생성합니다
                var customOverlay = new kakao.maps.CustomOverlay({
                    map: map,
                    position: positions[i].latlng,
                    content: content,
                    yAnchor: 1
                });

            }

        });

        function searchPlaces() {

            var keyword = document.getElementById('keyword').value;

            /*if (!keyword.replace(/^\s+|\s+$/g, '')) {
                alert('키워드를 입력해주세요!');
                return false;
            }*/
            var ps = new kakao.maps.services.Places();
            // 장소검색 객체를 통해 키워드로 장소검색을 요청합니다
            ps.keywordSearch(keyword, placesSearchCB);
        }
        // 키워드 검색 완료 시 호출되는 콜백함수 입니다
        // 장소검색이 완료됐을 때 호출되는 콜백함수 입니다
        function placesSearchCB(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {

                // 정상적으로 검색이 완료됐으면
                // 검색 목록과 마커를 표출합니다
                displayPlaces(data);

                // 페이지 번호를 표출합니다
                displayPagination(pagination);

            } else if (status === kakao.maps.services.Status.ZERO_RESULT) {

                alert('검색 결과가 존재하지 않습니다.');
                return;

            } else if (status === kakao.maps.services.Status.ERROR) {

                alert('검색 결과 중 오류가 발생했습니다.');
                return;

            }
        }
        function searchLocation() {
            var latitude = document.getElementById("latitude").value;
            var longitude = document.getElementById("longitude").value;
            var searchForm = document.getElementById("searchForm");

            searchForm.action = "/search?latitude=" + latitude + "&longitude=" + longitude;
            searchForm.submit();
        }
        function submitCheck(searchForm) {
            // 검색 위치가 선택되지 않았을 경우에 대한 예외 처리를 구현합니다.
            var position1 = document.getElementById("position1");
            var position2 = document.getElementById("position2");
            if (!position1.selected && !position2.selected) {
                alert("검색 위치를 선택해주세요.");
                return false;
            }
        }
    </script>
</div>
<script layout:fragment="script" type="text/javascript">
    const page_elements = document.getElementsByClassName("page-link");
    Array.from(page_elements).forEach(function (element) {
        element.addEventListener('click', function () {
            document.getElementById('page').value = this.dataset.page;
            document.getElementById('searchForm').submit();
        });
    });
</script>
</body>
</html>